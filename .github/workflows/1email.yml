name: Daily Subscription Email

on:
  schedule:
    - cron: "0 0 * * *"   # æ¯å¤© 00:00 UTCï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
  workflow_dispatch:        # âœ… æ‰‹åŠ¨è¿è¡ŒæŒ‰é’®

jobs:
  send_email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq grep coreutils

      - name: Search top 5 GitHub repositories
        run: |
          echo "ğŸ” æ­£åœ¨æœç´¢ GitHub ä¸Š star â‰¥ 100 çš„ v2rayN ä»“åº“..."
          curl -s "https://api.github.com/search/repositories?q=free+v2rayN+stars:>100&sort=updated&order=desc&per_page=5" \
            -H "Accept: application/vnd.github.v3+json" \
            -o repos.json
          jq -r '.items[].html_url' repos.json > repo_urls.txt

      - name: Extract .txt subscription links from README
        run: |
          echo "ğŸ“„ æ­£åœ¨æå– README ä¸­çš„è®¢é˜…é“¾æ¥..."
          > readmes.txt
          while read repo; do
            for branch in main master; do
              raw_url="${repo/github.com/raw.githubusercontent.com}/$branch/README.md"
              curl -fsSL "$raw_url" >> readmes.txt && break || true
            done
          done < repo_urls.txt
          grep -Eo 'https?://[^\s")]+\.txt' readmes.txt | sort -u > sub_links.txt
          echo "âœ… æå–åˆ°è®¢é˜…é“¾æ¥æ•°é‡: $(wc -l < sub_links.txt)"

      - name: Download subscriptions
        run: |
          echo "ğŸŒ æ­£åœ¨ä¸‹è½½è®¢é˜…å†…å®¹..."
          > nodes.txt
          while read url; do
            echo "ä¸‹è½½è®¢é˜…: $url"
            curl -fsSL "$url" >> nodes.txt || echo "âŒ ä¸‹è½½å¤±è´¥: $url"
          done < sub_links.txt

      - name: Detect format and decode if needed
        run: |
          echo "ğŸ” æ£€æµ‹è®¢é˜…æ ¼å¼..."
          if grep -Eq '^[A-Za-z0-9+/=]+$' nodes.txt; then
            echo "æ£€æµ‹åˆ° Base64 æ ¼å¼ï¼Œæ­£åœ¨è§£ç ..."
            base64 -d nodes.txt > decoded.txt || cp nodes.txt decoded.txt
          else
            echo "æ£€æµ‹åˆ°çº¯æ–‡æœ¬æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨"
            cp nodes.txt decoded.txt
          fi

      - name: Filter and group nodes
        run: |
          echo "ğŸ“¦ æ­£åœ¨ç­›é€‰å¹¶åˆ†ç»„èŠ‚ç‚¹..."
          echo "=== vmess èŠ‚ç‚¹ ===" > filtered.txt
          grep -i "vmess" decoded.txt >> filtered.txt || echo "æ—  vmess èŠ‚ç‚¹" >> filtered.txt

          echo "" >> filtered.txt
          echo "=== vless èŠ‚ç‚¹ ===" >> filtered.txt
          grep -i "vless" decoded.txt >> filtered.txt || echo "æ—  vless èŠ‚ç‚¹" >> filtered.txt

          echo "" >> filtered.txt
          echo "=== trojan èŠ‚ç‚¹ ===" >> filtered.txt
          grep -i "trojan" decoded.txt >> filtered.txt || echo "æ—  trojan èŠ‚ç‚¹" >> filtered.txt

          echo "" >> filtered.txt
          echo "=== èŠ‚ç‚¹ç»Ÿè®¡ ===" >> filtered.txt
          echo "vmess: $(grep -i "vmess" decoded.txt | wc -l)" >> filtered.txt
          echo "vless: $(grep -i "vless" decoded.txt | wc -l)" >> filtered.txt
          echo "trojan: $(grep -i "trojan" decoded.txt | wc -l)" >> filtered.txt

      - name: Send email with results
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "GitHub ä¼˜è´¨ v2rayN èŠ‚ç‚¹æ¨é€"
          from: ${{ secrets.MAIL_FROM }}
          to: ${{ secrets.MAIL_TO }}
          secure: true
          body_file: filtered.txt
          attachments: filtered.txt

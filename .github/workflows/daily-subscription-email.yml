name: Daily Subscription Email

on:
  schedule:
    - cron: "0 0 * * *"   # 每天 00:00 UTC（北京时间 08:00）
  workflow_dispatch:        # ✅ 手动运行按钮

jobs:
  send_email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq grep

      - name: Fetch top 5 repos
        run: |
          curl -s "https://api.github.com/search/repositories?q=free+v2rayN+stars:>100&sort=updated&order=desc&per_page=5" \
            -H "Accept: application/vnd.github.v3+json" \
            -o repos.json
          jq -r '.items[].html_url' repos.json > repo_urls.txt

      - name: Extract .txt subscription links
        run: |
          > readmes.txt
          while read repo; do
            for branch in main master; do
              raw_url="${repo/github.com/raw.githubusercontent.com}/$branch/README.md"
              curl -fsSL "$raw_url" >> readmes.txt || true
            done
          done < repo_urls.txt
          grep -Eo 'https?://[^\s")]+\.txt' readmes.txt | sort -u > sub_links.txt

      - name: Download subscriptions
        run: |
          > nodes.txt
          while read url; do
            echo "下载订阅: $url"
            curl -fsSL "$url" >> nodes.txt || echo "下载失败: $url"
          done < sub_links.txt

      - name: Detect and decode
        run: |
          if grep -Eq '^[A-Za-z0-9+/=]+$' nodes.txt; then
            base64 -d nodes.txt > decoded.txt || cp nodes.txt decoded.txt
          else
            cp nodes.txt decoded.txt
          fi

      - name: Filter and group nodes
        run: |
          echo "=== vmess 节点 ===" > filtered.txt
          grep -i "vmess" decoded.txt >> filtered.txt || echo "无 vmess 节点" >> filtered.txt

          echo "" >> filtered.txt
          echo "=== vless 节点 ===" >> filtered.txt
          grep -i "vless" decoded.txt >> filtered.txt || echo "无 vless 节点" >> filtered.txt

          echo "" >> filtered.txt
          echo "=== trojan 节点 ===" >> filtered.txt
          grep -i "trojan" decoded.txt >> filtered.txt || echo "无 trojan 节点" >> filtered.txt

          echo "" >> filtered.txt
          echo "=== 节点统计 ===" >> filtered.txt
          echo "vmess: $(grep -i "vmess" decoded.txt | wc -l)" >> filtered.txt
          echo "vless: $(grep -i "vless" decoded.txt | wc -l)" >> filtered.txt
          echo "trojan: $(grep -i "trojan" decoded.txt | wc -l)" >> filtered.txt

      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "GitHub 优质 v2rayN 节点推送"
          from: ${{ secrets.MAIL_FROM }}
          to: ${{ secrets.MAIL_TO }}
          secure: true
          body_file: filtered.txt
          attachments: filtered.txt
